{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "tien_widget.timer_schuduler",
    "name" : "Timer Schuduler",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 7.5,
      "sizeY" : 4.5,
      "resources" : [ ],
      "templateHtml" : "<div class=\"timer-widget\">\r\n    <h3 id=\"timer-name\">Timer Scheduler</h3>\r\n    <div id=\"timer-list\">\r\n        <!-- Các khoảng thời gian sẽ được thêm vào đây -->\r\n    </div>\r\n    <button id=\"add-timer\">Add Timer</button>\r\n    <button id=\"save-timers\">Save Timers</button>\r\n</div>\r\n",
      "templateCss" : "h3 {\r\n    font-weight: 600;\r\n}\r\n.timer-widget {\r\n    text-align: center;\r\n    height: 100%;\r\n    overflow-y: auto;\r\n}\r\n\r\n.timer {\r\n    display: inline-flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    margin-bottom: 20px;\r\n}\r\n\r\n.timer input[type=\"time\"] {\r\n    margin-left: 5px;\r\n    margin-right: 5px;\r\n    height: 100%;\r\n}\r\n\r\n.timer .days-of-week {\r\n    display: flex;\r\n    justify-content: center;\r\n    margin-left: 5px;\r\n    margin-right: 5px;\r\n}\r\n\r\n.timer .days-of-week label {\r\n    margin: 0 5px;\r\n}\r\n\r\nbutton {\r\n    margin: 5px;\r\n    padding: 10px;\r\n    font-size: 1em;\r\n}\r\n\r\n.timer button {\r\n    margin-left: 10px;\r\n    padding: 5px 10px;\r\n    font-size: 0.9em;\r\n}\r\n\r\n.timer .delete-icon {\r\n    margin: 5px;\r\n    cursor: pointer;\r\n    color: #d70000;\r\n    /* Màu đỏ để biểu thị xóa */\r\n    font-size: 32px;\r\n}\r\n\r\n#add-timer {\r\n    background-color: #4CAF50;\r\n    border: none;\r\n    color: white;\r\n    /* Màu chữ trắng */\r\n    padding: 10px 20px;\r\n    /* Khoảng đệm */\r\n    text-align: center;\r\n    /* Canh giữa văn bản */\r\n    text-decoration: none;\r\n    /* Không gạch chân */\r\n    display: inline-block;\r\n    /* Hiển thị như khối nội tuyến */\r\n    font-size: 18px;\r\n    /* Kích thước chữ */\r\n    cursor: pointer;\r\n    /* Con trỏ chuột */\r\n    border-radius: 6px;\r\n}\r\n\r\n#add-timer:hover {\r\n    background-color: #45a049;\r\n    /* Màu nền khi hover */\r\n    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\r\n    /* Bóng đổ khi hover */\r\n}\r\n#save-timers {\r\n    background-color: #0000d1;\r\n    border: none;\r\n    color: white;\r\n    /* Màu chữ trắng */\r\n    padding: 10px 20px;\r\n    /* Khoảng đệm */\r\n    text-align: center;\r\n    /* Canh giữa văn bản */\r\n    text-decoration: none;\r\n    /* Không gạch chân */\r\n    display: inline-block;\r\n    /* Hiển thị như khối nội tuyến */\r\n    font-size: 18px;\r\n    /* Kích thước chữ */\r\n    cursor: pointer;\r\n    /* Con trỏ chuột */\r\n    border-radius: 6px;\r\n}\r\n\r\n#save-timers:hover {\r\n    background-color: #00009d;\r\n    /* Màu nền khi hover */\r\n    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\r\n    /* Bóng đổ khi hover */\r\n}\r\n\r\n.timer .error {\r\n    border: 2px solid red;  /* Viền đỏ để biểu thị lỗi */\r\n}\r\n",
      "controllerScript" : "self.onInit = function() {\r\n    $scope = self.ctx.$scope;\r\n    attributeService = $scope.$injector.get(self.ctx.servicesMap.get('attributeService'));\r\n    translate = $scope.$injector.get(self.ctx.servicesMap.get('translate'));\r\n    var datasource = self.ctx.datasources[0];\r\n    var setings = self.ctx.settings;\r\n    var title = setings.title;\r\n    var label_start = setings.label1;\r\n    var label_end = setings.label2;\r\n    // console.log(datasource);\r\n    document.getElementById('timer-name').innerHTML = datasource.entityName + title;\r\n    \r\n    var timerList = document.getElementById('timer-list');\r\n    var addTimerButton = document.getElementById('add-timer');\r\n    var saveTimersButton = document.getElementById('save-timers');\r\n\r\n    // Function to create a timer element\r\n    function createTimerElement(startTime, endTime, days) {\r\n        var timerElement = document.createElement('div');\r\n        timerElement.className = 'timer';\r\n\r\n        var startTimeInput = document.createElement('input');\r\n        startTimeInput.type = 'time';\r\n        startTimeInput.value = startTime || '';\r\n\r\n        var endTimeInput = document.createElement('input');\r\n        endTimeInput.type = 'time';\r\n        endTimeInput.value = endTime || '';\r\n\r\n        var daysOfWeek = document.createElement('div');\r\n        daysOfWeek.className = 'days-of-week';\r\n\r\n        var daysArray = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\r\n        daysArray.forEach(function(day, index) {\r\n            var label = document.createElement('label');\r\n            var checkbox = document.createElement('input');\r\n            checkbox.type = 'checkbox';\r\n            checkbox.value = index;\r\n            if (days && days.includes(index.toString())) {\r\n                checkbox.checked = true;\r\n            }\r\n            label.appendChild(checkbox);\r\n            label.appendChild(document.createTextNode(day));\r\n            daysOfWeek.appendChild(label);\r\n        });\r\n\r\n        // var deleteIcon = document.createElement('i');\r\n        // deleteIcon.className = 'fas fa-trash delete-icon';\r\n        var deleteIcon = document.createElement('mat-icon');\r\n        deleteIcon.className = 'material-icons delete-icon';\r\n        deleteIcon.textContent = 'delete';\r\n        deleteIcon.onclick = function() {\r\n            timerElement.remove();\r\n        };\r\n\r\n        timerElement.appendChild(document.createTextNode(label_start));\r\n        timerElement.appendChild(startTimeInput);\r\n        timerElement.appendChild(document.createTextNode(label_end));\r\n        timerElement.appendChild(endTimeInput);\r\n        timerElement.appendChild(daysOfWeek);\r\n        timerElement.appendChild(deleteIcon);\r\n        \r\n        // Add event listener for end time input\r\n        endTimeInput.addEventListener('input', function() {\r\n            validateSingleTimer(timerElement);\r\n        });\r\n        \r\n        return timerElement;\r\n    }\r\n    \r\n    // Function to validate a single timer and highlight errors\r\n    function validateSingleTimer(timerElement) {\r\n        var startTimeInput = timerElement.querySelector('input[type=\"time\"]');\r\n        var endTimeInput = timerElement.querySelectorAll('input[type=\"time\"]')[1];\r\n        var timeSta = startTimeInput.value;\r\n        var timeEn = endTimeInput.value;\r\n\r\n        // Clear previous error styles\r\n        startTimeInput.classList.remove('error');\r\n        endTimeInput.classList.remove('error');\r\n\r\n        // Check if end time is greater than start time\r\n        if (timeEn <= timeSta) {\r\n            startTimeInput.classList.add('error');\r\n            endTimeInput.classList.add('error');\r\n            $scope.showErrorToast(\"Thời gian kết thúc phải lớn hơn thời gian bắt đầu\", 'top', 'left', $scope.toastTargetId);\r\n        }\r\n    }\r\n    \r\n    // Function to validate timers\r\n    function validateTimers(timerElements) {\r\n        var isValid = true;\r\n        timerElements.forEach(function(timerElement) {\r\n            var startTimeInput = timerElement.querySelector('input[type=\"time\"]');\r\n            var endTimeInput = timerElement.querySelectorAll('input[type=\"time\"]')[1];\r\n            var timeStat = startTimeInput.value;\r\n            var timeEnd = endTimeInput.value;\r\n\r\n            // Clear previous error styles\r\n            startTimeInput.classList.remove('error');\r\n            endTimeInput.classList.remove('error');\r\n\r\n            // Check if end time is greater than start time\r\n            if (timeEnd <= timeStat) {\r\n                startTimeInput.classList.add('error');\r\n                endTimeInput.classList.add('error');\r\n                isValid = false;\r\n            }\r\n        });\r\n        return isValid;\r\n    }\r\n\r\n    // Add new timer element on button click\r\n    addTimerButton.addEventListener('click', function() {\r\n        var timerElement = createTimerElement();\r\n        timerList.appendChild(timerElement);\r\n    });\r\n\r\n    // Save timers to attributes on button click\r\n    saveTimersButton.addEventListener('click', function() {\r\n        var timers = [];\r\n        var timerElements = document.querySelectorAll('.timer');\r\n        \r\n        if (!validateTimers(timerElements)) {\r\n            $scope.showErrorToast(\"Thời gian kết thúc phải lớn hơn thời gian bắt đầu\", 'top', 'left', $scope.toastTargetId);\r\n            return;\r\n        }\r\n        \r\n        timerElements.forEach(function(timerElement) {\r\n            var startTime = timerElement.querySelector('input[type=\"time\"]').value;\r\n            var endTime = timerElement.querySelectorAll('input[type=\"time\"]')[1].value;\r\n            var daysOfWeek = [];\r\n            var checkboxes = timerElement.querySelectorAll('.days-of-week input[type=\"checkbox\"]');\r\n            checkboxes.forEach(function(checkbox) {\r\n                if (checkbox.checked) {\r\n                    daysOfWeek.push(checkbox.value);\r\n                }\r\n            });\r\n            timers.push({ start: startTime, end: endTime, days: daysOfWeek });\r\n        });\r\n\r\n        var timersJSON = JSON.stringify(timers);\r\n        let attributesArray = [{\r\n                key: \"timers\",\r\n                value: timersJSON\r\n            }];\r\n        // Save timersJSON to device attributes\r\n        attributeService.saveEntityAttributes(\r\n                datasource.entity.id,\r\n                \"SERVER_SCOPE\", attributesArray).subscribe(\r\n                function success() {\r\n                        $scope.showSuccessToast(translate.instant('widgets.input-widgets.update-successful'), 1000, 'bottom', 'right', $scope.toastTargetId);\r\n                },\r\n                function fail() {\r\n                        $scope.showErrorToast(translate.instant('widgets.input-widgets.update-failed'), 'bottom', 'right', $scope.toastTargetId);\r\n                }\r\n            );\r\n    });\r\n\r\n    // Retrieve saved timers from ThingsBoard attributes and populate the UI\r\n    attributeService.getEntityAttributes(datasource.entity.id, 'SERVER_SCOPE', ['timers']).subscribe(\r\n        function success(attributes) {\r\n            if (attributes.length > 0 && attributes[0].key === 'timers' && attributes[0].value) {\r\n                var savedTimers = JSON.parse(attributes[0].value);\r\n                savedTimers.forEach(function(timer) {\r\n                    var timerElement = createTimerElement(timer.start, timer.end, timer.days);\r\n                    timerList.appendChild(timerElement);\r\n                });\r\n            }\r\n        },\r\n        function failure(error) {\r\n            console.error('Failed to load timers:', error);\r\n            $scope.showErrorToast(translate.instant(error), 'bottom', 'right', $scope.toastTargetId);\r\n        }\r\n    );\r\n};\r\n\r\nself.onDestroy = function() {\r\n    // Clean up any resources if needed\r\n};\r\n",
      "settingsSchema" : "{\n    \"form\": [\n        \"title\",\n        \"label1\",\n        \"label2\"\n    ],\n    \"schema\": {\n        \"type\": \"object\",\n        \"title\": \"Settings\",\n        \"properties\": {\n            \"title\": {\n                \"title\": \"Tiêu đề\",\n                \"type\": \"string\",\n                \"default\": \"Timer Scheduler\"\n            },\n            \"label1\": {\n                \"title\": \"Nhãn thời gian bắt đầu\",\n                \"type\": \"string\",\n                \"default\": \"ON \"\n            },\n            \"label2\": {\n                \"title\": \"Nhãn thời gian kết thúc\",\n                \"type\": \"string\",\n                \"default\": \" to \"\n            }\n            \n        },\n        \"required\": [\n        ]\n    }\n}",
      "dataKeySettingsSchema" : "{}\n",
      "defaultConfig" : "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"title\":\"Timer Scheduler\",\"label1\":\"On\",\"label2\":\"to\"},\"title\":\"Timer Schuduler\"}"
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "ed015450-822a-11f0-b2a5-330a0128a863"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "ed015450-822a-11f0-b2a5-330a0128a863"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}